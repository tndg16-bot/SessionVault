/**
 * ChatGPT Content Script
 * Extracts conversation from chat.openai.com
 */

(function() {
  'use strict';

  /**
   * Extract all messages from ChatGPT conversation
   * @returns {Array<{role: string, content: string}>}
   */
  function extractConversation() {
    const messages = [];
    
    try {
      // Get all message elements with role attribute
      const messageElements = document.querySelectorAll('[data-message-author-role]');
      console.log(`[SessionVault] Found ${messageElements.length} message elements`);
      
      messageElements.forEach((element, index) => {
        const role = element.getAttribute('data-message-author-role');
        
        // Get content using multiple methods
        let content = '';
        
        // Method 1: Direct innerText
        if (element.innerText) {
          content = element.innerText.trim();
        }
        
        // Method 2: Get from markdown container if empty
        if (content.length === 0) {
          const markdownEl = element.querySelector('.markdown, .whitespace-pre-wrap');
          if (markdownEl) {
            content = markdownEl.innerText.trim();
          }
        }
        
        // Method 3: Get from children recursively
        if (content.length === 0) {
          const children = Array.from(element.children);
          content = children
            .map(child => child.innerText)
            .filter(text => text && text.trim().length > 0)
            .join('\n\n')
            .trim();
        }
        
        // Log for debugging
        const preview = content.substring(0, 50).replace(/\n/g, ' ');
        console.log(`[SessionVault] Message ${index}: role=${role}, contentLength=${content.length}, preview="${preview}..."`);
        
        // Only add if we have content
        if (content && content.length > 0) {
          messages.push({
            role: role === 'user' ? 'user' : 'assistant',
            content: content
          });
        }
      });
      
      console.log(`[SessionVault] Extracted ${messages.length} valid messages out of ${messageElements.length} elements`);
    } catch (error) {
      console.error('[SessionVault] Error in extractConversation:', error);
    }
    
    return messages;
  }

  /**
   * Get conversation title from page
   * @returns {string}
   */
  function getConversationTitle() {
    try {
      // Try to get title from active conversation in sidebar
      const titleElement = document.querySelector('nav [class*="active"] .truncate') ||
                          document.querySelector('h1') ||
                          document.querySelector('title');
      
      if (titleElement) {
        const title = titleElement.innerText || titleElement.textContent;
        if (title && title !== 'ChatGPT') {
          return title.trim();
        }
      }
      
      return `ChatGPT-${new Date().toISOString().split('T')[0]}`;
    } catch (error) {
      console.error('[SessionVault] Error getting title:', error);
      return `ChatGPT-${new Date().toISOString().split('T')[0]}`;
    }
  }

  /**
   * Get current conversation URL
   * @returns {string}
   */
  function getConversationUrl() {
    try {
      return window.location.href;
    } catch (error) {
      console.error('[SessionVault] Error getting URL:', error);
      return '';
    }
  }

  /**
   * Format conversation as Markdown
   * @param {Array<{role: string, content: string}>} messages
   * @returns {string}
   */
  function formatAsMarkdown(messages) {
    try {
      let markdown = '';
      
      messages.forEach((msg) => {
        const roleLabel = msg.role === 'user' ? '**User**' : '**Assistant**';
        markdown += `### ${roleLabel}\n\n${msg.content}\n\n---\n\n`;
      });
      
      return markdown;
    } catch (error) {
      console.error('[SessionVault] Error formatting markdown:', error);
      return '';
    }
  }

  // Listen for messages from popup/background
  chrome.runtime.onMessage.addListener((request, sender, sendResponse) => {
    console.log('[SessionVault] Content script received message:', request);
    
    if (request.action === 'extractConversation') {
      try {
        console.log('[SessionVault] Starting conversation extraction...');
        
        const messages = extractConversation();
        const title = getConversationTitle();
        const url = getConversationUrl();
        const markdown = formatAsMarkdown(messages);
        
        const responseData = {
          title: title,
          url: url,
          messages: messages,
          markdown: markdown,
          source: 'ChatGPT',
          extractedAt: new Date().toISOString()
        };
        
        console.log('[SessionVault] Extraction complete:', { messageCount: messages.length });
        console.log('[SessionVault] Sending response...');
        console.log('[SessionVault] Response data keys:', Object.keys(responseData));
        
        // Use setTimeout to ensure response is sent properly
        setTimeout(() => {
          sendResponse({
            success: true,
            data: responseData
          });
          console.log('[SessionVault] Response sent');
        }, 100);
        
        // Return true for async response
        return true;
      } catch (error) {
        console.error('[SessionVault] Error in message handler:', error);
        sendResponse({
          success: false,
          error: error.message
        });
        return true;
      }
    }
  });

  // Notify that content script is loaded
  console.log('[SessionVault] ChatGPT content script loaded');
  console.log('[SessionVault] Message listener registered');
})();
